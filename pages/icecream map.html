<!DOCTYPE html>
<html>
<head>
    <title>è¶…å•†åˆ†å±¤åœ°åœ–</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        /* åŸºç¤æ¨£å¼èˆ‡éŸ¿æ‡‰å¼ */
        html, body, #map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 600px; 
        }
        
        /* æ‰‹æ©Ÿæœ€ä½³åŒ–ï¼šå¼·åˆ¶ä½”æ»¿æ•´å€‹è¦–çª—é«˜åº¦ */
        @media (max-width: 768px) {
            html, body {
                height: 100vh;
            }
            #map {
                height: 100vh; 
            }
        }
        
        /* è¨­ç½®è‡ªè¨‚å®šä½æŒ‰éˆ•åœ–æ¨™å’Œå¤–è§€ */
        .leaflet-control-locate a {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="%23333" d="M16 4c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10zm0 3c-3.866 0-7 3.134-7 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 2c2.761 0 5 2.239 5 5s-2.239 5-5 5-5-2.239-5-5 2.239-5 5-5z"/></svg>');
            background-size: 26px 26px;
            background-position: 50% 50%;
            background-repeat: no-repeat;
            display: block;
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }

        /* è‡ªè¨‚åœ“å½¢æ¨™è¨˜åŸºç¤æ¨£å¼ (L.DivIcon) */
        .circle-icon {
            box-sizing: border-box; 
            text-align: center;
            line-height: 20px; 
            font-size: 12px;
            font-weight: bold;
            color: #000000; /* æ–‡å­—é»‘è‰² */
            border: 3px solid #000000; 
            border-radius: 50%; 
            width: 26px; 
            height: 26px; 
            opacity: 1;
        }

        /* å…¨å®¶å°ˆå±¬é¡è‰² */
        .family-icon {
            background-color: #00CC66; /* å¾®äº®ç¶ è‰² */
        }
        
        /* 7-11 å°ˆå±¬é¡è‰² */
        .seven11-icon {
            background-color: #FF8C00; /* é®®è±”æ©˜è‰² */
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // =================================================================
        // ğŸŒŸ è¶…ç´šæ–¹ä¾¿æ‰“é»å€ ğŸŒŸ
        // æ ¼å¼ï¼š[ç·¯åº¦, ç¶“åº¦, 'åç¨±', 'åœ–å±¤åç¨± (å…¨å®¶/7-11)', 'å½ˆå‡ºè¦–çª—å…§å®¹', 'è¨»è¨˜å­— (å–®ä¸€å­—å…ƒï¼Œéå¿…è¦)']
        // =================================================================
        const STORE_DATA = [
            // å…¨å®¶åº—é¢
            [25.0478, 121.5160, 'å…¨å®¶åŒ—è»Šåº—', 'å…¨å®¶', 'æœ€è¿‘çš„ç«è»Šç«™å‡ºå£', 'ç™¼'],
            [25.0450, 121.5205, 'å…¨å®¶è¯å±±åº—', 'å…¨å®¶', 'é è¿‘è¯å±±æ–‡å‰µåœ’å€', ''], 
            
            // 7-11 åº—é¢
            [25.0485, 121.5175, '7-11æ·é‹åº—', '7-11', 'æ·é‹å‡ºå£æ—çš„ 7-11', 'å¿«'],
            [25.0490, 121.5155, '7-11å…¬åœ’åº—', '7-11', 'é™„è¿‘æœ‰å…¬åœ’', ''],
        ];
        
        
        // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºå¸¶æ–‡å­—çš„ L.DivIcon æ¨™è¨˜
        function getStoreIcon(layerName, noteText) {
            let className = 'circle-icon ';
            
            if (layerName === 'å…¨å®¶') {
                className += 'family-icon';
            } else if (layerName === '7-11') {
                className += 'seven11-icon';
            }
            
            // å¦‚æœæ²’æœ‰è¨»è¨˜å­—ï¼Œå‰‡ä½¿ç”¨ä¸€å€‹ç©ºæ ¼ï¼Œç¢ºä¿åœ“é»å½¢ç‹€ä¸æœƒè·‘æ‰
            const htmlContent = noteText.trim() || '&nbsp;'; 

            return L.divIcon({
                className: className,
                html: htmlContent,
                iconSize: [26, 26], 
                iconAnchor: [13, 13] // å®šä½åˆ°åœ“å¿ƒ
            });
        }


        // é è¨­ä½ç½®
        const TAIPEI_STATION_COORD = [25.0477, 121.5170];
        const INITIAL_ZOOM = 15;
        
        let currentLocationMarker;
        let accuracyCircle;

        // 1. åˆå§‹åŒ–åœ°åœ–
        const map = L.map('map', {
            center: TAIPEI_STATION_COORD,
            zoom: INITIAL_ZOOM,
            zoomControl: true 
        });

        // 2. åŠ å…¥ OpenStreetMap åœ–å±¤
        const osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);


        // 3. å‰µå»ºåœ–å±¤ç¾¤çµ„
        const familyMartGroup = L.layerGroup();
        const sevenElevenGroup = L.layerGroup();

        // 4. æ ¹æ“š STORE_DATA é™£åˆ—å‹•æ…‹æ–°å¢æ‰“é»
        STORE_DATA.forEach(data => {
            const [lat, lng, name, layerName, popupContent, noteText] = data;
            
            const iconToUse = getStoreIcon(layerName, noteText);

            const marker = L.marker([lat, lng], {
                icon: iconToUse
            }).bindPopup(`<b>${name}</b><br>${popupContent}`);

            if (layerName === 'å…¨å®¶') {
                marker.addTo(familyMartGroup);
            } else if (layerName === '7-11') {
                marker.addTo(sevenElevenGroup);
            }
        });
        
        familyMartGroup.addTo(map);
        sevenElevenGroup.addTo(map);


        // 5. åŠ å…¥åœ–å±¤æ§åˆ¶é …
        const baseLayers = {
            "OpenStreetMap": osmLayer
        };

        const overlayLayers = {
            "ğŸŸ¢ å…¨å®¶ (ç¶ åœ“)": familyMartGroup,
            "ğŸŸ  7-11 (æ©˜åœ“)": sevenElevenGroup 
        };
        
        L.control.layers(baseLayers, overlayLayers, {
            collapsed: false 
        }).addTo(map);


        // --- å®šä½åŠŸèƒ½å¯¦ä½œ ---
        function onLocationFound(e) {
            const radius = e.accuracy;
            const latlng = e.latlng;
            
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
            }

            currentLocationMarker = L.marker(latlng).addTo(map)
                .bindPopup("æ‚¨ç›®å‰çš„ä½ç½®ï¼Œèª¤å·®ç´„ " + radius.toFixed(0) + " å…¬å°º").openPopup();

            accuracyCircle = L.circle(latlng, radius, {
                color: 'blue',
                fillColor: '#30f',
                fillOpacity: 0.1,
                weight: 1
            }).addTo(map);

            map.setView(latlng, Math.min(map.getZoom(), 16));
        }

        function onLocationError(e) {
            console.error(e.message);
            alert("ç„¡æ³•å–å¾—æ‚¨çš„åœ°ç†ä½ç½®ã€‚\néŒ¯èª¤è¨Šæ¯: " + e.message + "\nåœ°åœ–å°‡é¡¯ç¤ºå°åŒ—ç«è»Šç«™ã€‚");
            map.setView(TAIPEI_STATION_COORD, INITIAL_ZOOM);
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // è‡ªè¨‚å®šä½æ§åˆ¶æŒ‰éˆ• (ä¿ç•™æ­¤é‚è¼¯ä»¥æ­é…ä¸Šæ–¹çš„ CSS æ¨£å¼)
        const LocateControl = L.Control.extend({
            options: {
                position: 'topleft'
            },
            onAdd: function (map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');
                const link = L.DomUtil.create('a', '', container);
                link.href = '#';
                link.title = 'å®šä½åˆ°æ‚¨çš„ä½ç½®';
                link.role = 'button';
                L.DomEvent.on(link, 'click', L.DomEvent.stop)
                          .on(link, 'click', function () {
                              map.locate({setView: true, maxZoom: 16});
                          });
                return container;
            }
        });
        map.addControl(new LocateControl());

        // ç¶²é é–‹å•Ÿæ™‚çš„åˆå§‹å®šä½è«‹æ±‚
        map.locate({
            setView: true,
            maxZoom: 16,   
            watch: false,  
            enableHighAccuracy: true
        });

    </script>

</body>
</html>
